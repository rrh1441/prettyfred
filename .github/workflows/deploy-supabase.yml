name: Deploy Supabase Functions

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Check out your code
      - uses: actions/checkout@v3

      # 2) Download & install the official Supabase CLI (latest version)
      - name: Install Supabase CLI (Official Binary)
        run: |
          VERSION="$(curl -s https://api.github.com/repos/supabase/cli/releases/latest | grep tag_name | cut -d '\"' -f4)"
          echo "Latest Supabase CLI version is $VERSION"
          
          # Download & extract the linux_amd64 tar to /tmp
          curl -L "https://github.com/supabase/cli/releases/download/$VERSION/supabase_${VERSION#v}_linux_amd64.tar.gz" \
            | tar xz -C /tmp
          
          # Move supabase binary into /usr/local/bin
          sudo mv /tmp/supabase /usr/local/bin/supabase
          
          # Check version
          supabase --version

      # 3) Log in using your personal access token
      - name: Log in to Supabase
        run: supabase login --token "${{ secrets.SUPABASE_ACCESS_TOKEN }}"

      # 4) Link to your project (replace with your actual project ref if different)
      - name: Link to Supabase project
        run: supabase link --project-ref ltiuuauafphpwewqktdv

      # 5) Set environment secrets for the Edge Function
      - name: Set environment variables
        run: |
          supabase secrets set SERVICE_ROLE="${{ secrets.SERVICE_ROLE }}"
          supabase secrets set URL="${{ secrets.URL }}"
          supabase secrets set FRED_API_KEY="${{ secrets.FRED_API_KEY }}"

      # 6) Deploy your 'fetch_fred_data' Edge Function
      - name: Deploy Supabase Function
        run: supabase functions deploy fetch_fred_data --no-verify-jwt

      # 7) List functions (for debugging to confirm the function is deployed)
      - name: List Supabase Functions
        run: supabase functions list